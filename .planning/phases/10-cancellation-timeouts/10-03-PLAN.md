---
phase: 10-cancellation-timeouts
plan: 03
type: execute
wave: 3
depends_on: [10-01, 10-02]
files_modified:
  - forge_agent/src/workflow/mod.rs
  - forge_agent/src/workflow/cancellation.rs
  - forge_agent/src/workflow/examples.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tasks can cooperatively poll cancellation token"
    - "Long-running tasks can exit early on cancellation"
    - "Example demonstrates cancellation-aware task implementation"
    - "Best practices documented for cooperative cancellation"
    - "Cancellation works with timeout (both can trigger task exit)"
  artifacts:
    - path: "forge_agent/src/workflow/examples.rs"
      provides: "Cancellation-aware task examples"
      min_lines: 200
      exports: ["CancellationAwareTask", "PollingTask", "CooperativeCancellationExample"]
    - path: "forge_agent/src/workflow/cancellation.rs"
      provides: "Cooperative cancellation utilities"
      min_lines: 350
      exports: ["CancellationToken::poll_cancelled", "CancellationToken::wait_cancelled"]
    - path: "forge_agent/src/workflow/mod.rs"
      provides: "Examples module exported"
  key_links:
    - from: "forge_agent/src/workflow/examples.rs"
      to: "forge_agent/src/workflow/task.rs"
      via: "WorkflowTask trait implementation for example tasks"
      pattern: "impl WorkflowTask for"
    - from: "forge_agent/src/workflow/examples.rs"
      to: "forge_agent/src/workflow/cancellation.rs"
      via: "CancellationToken polling in task execute() methods"
      pattern: "context.cancellation_token.*is_cancelled"
---

# Plan 10-03: Cooperative Cancellation in Async Loops

## Objective

Implement cooperative cancellation patterns for long-running tasks and provide best-practice examples.

**Purpose:** Enable tasks to respond to cancellation signals by polling the cancellation token during async loops, allowing graceful shutdown without forcing termination.

**Output:** Working cooperative cancellation examples with documentation and utility functions.

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/10-cancellation-timeouts/10-01-PLAN.md
@.planning/phases/10-cancellation-timeouts/10-02-PLAN.md

@forge_agent/src/workflow/cancellation.rs
@forge_agent/src/workflow/task.rs
@forge_agent/src/workflow/examples.rs

## Requirements Mapped

- **WSTA-03:** User can cancel running workflow via async cancellation token
  - Extended: Tasks must cooperatively poll token for cancellation to be effective
  - This plan provides patterns and examples for cooperative cancellation

## Tasks

<task type="auto">
  <name>Task 1: Extend cancellation module with cooperative utilities</name>
  <files>forge_agent/src/workflow/cancellation.rs</files>
  <action>
Modify forge_agent/src/workflow/cancellation.rs to add cooperative cancellation helpers:

1. Add poll_cancelled(&self) -> bool method to CancellationToken
   - Returns true if token is cancelled
   - Convenience alias for is_cancelled() (better semantics for polling)

2. Add wait_cancelled(&self) async -> WaitCancelledFuture method to CancellationToken
   - Returns a Future that completes when token is cancelled
   - Use tokio::sync::Notify for efficient waiting
   - Impl Future for WaitCancelledFuture
   - cancel() method notifies all waiters

3. Add tokio::sync::Notify field to CancellationTokenSource
   - Updated on cancel() to notify all waiting tasks
   - Stored in Arc for sharing across token clones

4. Update CancellationToken to include Arc<Notify> reference
   - Clone gets the same Arc reference
   - wait_cancelled() uses this notify

5. Add unit tests (minimum 6):
   - test_poll_cancelled_returns_false_initially
   - test_poll_cancelled_returns_true_after_cancel
   - test_wait_cancelled_completes_on_cancel
   - test_wait_cancelled_multiple_waiters
   - test_wait_cancelled_idempotent
   - test_cooperative_cancellation_pattern

6. Add documentation comments with examples showing:
   - Polling pattern in loops
   - Wait pattern for async tasks
   - Combined with tokio::select! for race with timeout
  </action>
  <verify>cargo test -p forge_agent workflow::cancellation::tests::test_cooperative</verify>
  <done>
CancellationToken has cooperative utilities with:
- poll_cancelled() method for polling in loops
- wait_cancelled() async method for awaiting cancellation
- tokio::sync::Notify for efficient cancellation broadcast
- Multiple waiters supported
- All unit tests passing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cancellation-aware example tasks</name>
  <files>forge_agent/src/workflow/examples.rs</files>
  <action>
Modify forge_agent/src/workflow/examples.rs (or create if minimal):

1. Create CancellationAwareTask struct demonstrating cooperative cancellation:
   ```rust
   pub struct CancellationAwareTask {
       id: TaskId,
       name: String,
       iterations: usize,
       delay_ms: u64,
   }
   ```
   - Executes a loop with delay between iterations
   - Polls cancellation token each iteration
   - Returns TaskResult::Cancelled if token is set
   - Returns TaskResult::Success with completed iterations count

2. Create PollingTask struct demonstrating tokio::select! pattern:
   ```rust
   pub struct PollingTask {
       id: TaskId,
       name: String,
       total_duration_ms: u64,
   }
   ```
   - Uses tokio::select! to race between work and cancellation
   - Shows proper async cancellation handling
   - Cleans up resources on cancellation

3. Create CooperativeCancellationExample function:
   - Creates a workflow with 3 cancellation-aware tasks
   - Spawns a cancellation request after 200ms
   - Demonstrates tasks exiting gracefully
   - Prints progress and cancellation messages

4. Add unit tests (minimum 4):
   - test_cancellation_aware_task_stops_on_cancel
   - test_cancellation_aware_task_completes_without_cancel
   - test_polling_task_with_tokio_select
   - test_cooperative_cancellation_example

5. Add module documentation with best practices:
   - When to use polling vs. waiting
   - How to handle cleanup on cancellation
   - Interaction with timeouts
   - Common pitfalls (blocking code, forgetting to poll)
  </action>
  <verify>cargo test -p forge_agent workflow::examples::tests</verify>
  <done>
Examples module has:
- CancellationAwareTask with loop polling pattern
- PollingTask with tokio::select! pattern
- CooperativeCancellationExample demonstrating full workflow
- Unit tests verifying cancellation behavior
- Documentation with best practices
- All tests passing
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cancellation + timeout integration example</name>
  <files>forge_agent/src/workflow/examples.rs</files>
  <action>
Modify forge_agent/src/workflow/examples.rs to add:

1. Create TimeoutAndCancellationTask struct:
   ```rust
   pub struct TimeoutAndCancellationTask {
       id: TaskId,
       name: String,
       work_duration_ms: u64,
   }
   ```
   - Demonstrates handling both timeout and cancellation
   - Uses tokio::select! with three branches:
     a) Work completion
     b) Timeout (via tokio::time::sleep)
     c) Cancellation (via token.wait_cancelled())
   - Returns appropriate TaskResult based on which branch completes

2. Create TimeoutCancellationExample function:
   - Creates workflow with timeout config (100ms workflow timeout)
   - Adds cancellation source
   - Demonstrates task exiting on either condition
   - Shows which condition triggered (timeout vs. cancellation)

3. Add unit tests (minimum 3):
   - test_task_exits_on_timeout_before_cancellation
   - test_task_exits_on_cancellation_before_timeout
   - test_task_completes_before_timeout_and_cancellation

4. Update module documentation with:
   - How to combine cancellation and timeout effectively
   - Which takes precedence (both should be checked)
   - Error handling recommendations

5. Verify examples.rs is exported in mod.rs if not already
  </action>
  <verify>cargo test -p forge_agent workflow::examples::tests::test_timeout_cancellation</verify>
  <done>
Examples module has:
- TimeoutAndCancellationTask demonstrating dual condition handling
- TimeoutCancellationExample showing combined use
- Tests verifying timeout and cancellation interaction
- Updated documentation
- All tests passing
  </done>
</task>

<task type="auto">
  <name>Task 4: Add documentation and export examples module</name>
  <files>forge_agent/src/workflow/mod.rs</files>
  <action>
Modify forge_agent/src/workflow/mod.rs:

1. Ensure examples module is declared: pub mod examples;

2. Add selective re-exports for example types:
   ```rust
   pub use examples::{
       CancellationAwareTask,
       PollingTask,
       TimeoutAndCancellationTask,
   };
   ```

3. Add top-level module documentation summarizing:
   - Cancellation and timeout features
   - Links to example tasks
   - Quick start guide

4. Add doc comment to cancellation::CancellationToken with:
   - Reference to examples module
   - Common patterns

5. Run cargo doc --no-deps to verify documentation builds without warnings

6. Add documentation test (doctest) in examples.rs:
   - ```rust,no_run
   - /// ```rust
   - /// use forge_agent::workflow::{Workflow, WorkflowBuilder, CancellationAwareTask};
   - /// use forge_agent::workflow::cancellation::CancellationTokenSource;
   - /// ```
     - Shows basic usage pattern
     - Must compile (no_run because it requires tokio runtime)

7. Verify all public types have doc comments
  </action>
  <verify>cargo doc --no-deps -p forge_agent && cargo test -p forge_agent --doc</verify>
  <done>
Examples module exported with:
- Public re-exports of example task types
- Module-level documentation
- Doc comments on all public types
- Documentation tests passing
- cargo doc builds without warnings
  </done>
</task>

</tasks>

## Verification

1. All unit tests pass (15+ tests)
2. Cooperative cancellation examples demonstrate proper patterns
3. Timeout + cancellation integration example works
4. Documentation builds without warnings
5. Doc tests compile and pass
6. Backward compatibility maintained

## Success Criteria

1. Tasks can cooperatively poll cancellation token
2. Long-running tasks can exit early on cancellation
3. Example demonstrates cancellation-aware task implementation
4. Best practices documented for cooperative cancellation
5. Cancellation works with timeout (both can trigger task exit)

## Output

After completion, create `.planning/phases/10-cancellation-timeouts/10-03-SUMMARY.md`
