---
phase: 10-cancellation-timeouts
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - forge_agent/Cargo.toml
  - forge_agent/src/workflow/mod.rs
  - forge_agent/src/workflow/timeout.rs
  - forge_agent/src/workflow/executor.rs
  - forge_agent/src/workflow/task.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Individual tasks have configurable timeout limits"
    - "Entire workflow has configurable timeout limit"
    - "tokio::time::timeout for workflow-level timeout"
    - "tokio::time::sleep for per-task timeout"
    - "TimeoutError variant in TaskResult and WorkflowError"
    - "Timeout events recorded to audit log"
  artifacts:
    - path: "forge_agent/src/workflow/timeout.rs"
      provides: "TaskTimeout, WorkflowTimeout, TimeoutConfig"
      min_lines: 250
      exports: ["TaskTimeout", "WorkflowTimeout", "TimeoutConfig", "TimeoutError"]
    - path: "forge_agent/src/workflow/executor.rs"
      provides: "Timeout integration in executor"
      min_lines: 1000
    - path: "forge_agent/src/workflow/task.rs"
      provides: "TaskTimeout in TaskContext"
      min_lines: 470
  key_links:
    - from: "forge_agent/src/workflow/executor.rs"
      to: "tokio::time::timeout"
      via: "execute_with_timeout wrapper method"
      pattern: "tokio::time::timeout"
    - from: "forge_agent/src/workflow/task.rs"
      to: "forge_agent/src/workflow/timeout.rs"
      via: "TaskContext.task_timeout field"
      pattern: "task_timeout.*Duration"
    - from: "forge_agent/src/workflow/executor.rs"
      to: "forge_agent/src/audit.rs"
      via: "WorkflowTaskTimedOut event recording"
      pattern: "WorkflowTaskTimedOut"
---

# Plan 10-02: Timeout Handling for Tasks and Workflows

## Objective

Implement configurable timeout limits for individual tasks and entire workflows using tokio::time primitives.

**Purpose:** Prevent workflows and tasks from running indefinitely by enforcing time limits with proper error handling and audit logging.

**Output:** Working timeout system integrated into WorkflowExecutor and TaskContext.

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/10-cancellation-timeouts/10-01-PLAN.md

@forge_agent/src/workflow/executor.rs
@forge_agent/src/workflow/task.rs
@forge_agent/src/audit.rs

## Requirements Mapped

- **WSTA-04:** Individual tasks and entire workflow have configurable timeout limits
  - Task-level timeout via TaskContext with tokio::time::sleep
  - Workflow-level timeout via tokio::time::timeout wrapper

## Tasks

<task type="auto">
  <name>Task 1: Create timeout module with timeout configuration types</name>
  <files>forge_agent/src/workflow/timeout.rs</files>
  <action>
Create new module forge_agent/src/workflow/timeout.rs with:

1. TimeoutError enum for timeout-specific errors
   - TaskTimeout { task_id: TaskId, timeout: Duration } - Task exceeded time limit
   - WorkflowTimeout { timeout: Duration } - Workflow exceeded time limit
   - Impl Display for user-friendly error messages
   - Impl Error for error trait compatibility

2. TaskTimeout struct wrapping Duration
   - new(duration: Duration) -> Self
   - from_secs(secs: u64) -> Self convenience constructor
   - from_millis(millis: u64) -> Self convenience constructor
   - duration(&self) -> Duration accessor
   - Default: 30 seconds
   - Impl Clone, Copy, Debug, PartialEq, Eq

3. WorkflowTimeout struct wrapping Duration
   - Similar API to TaskTimeout
   - Default: 5 minutes
   - Impl Clone, Copy, Debug, PartialEq, Eq

4. TimeoutConfig struct combining both timeouts
   - task_timeout: Option<TaskTimeout> - None means no task timeout
   - workflow_timeout: Option<WorkflowTimeout> - None means no workflow timeout
   - new() -> Self with default timeouts (30s task, 5m workflow)
   - no_task_timeout() -> Self disables task timeout
   - no_workflow_timeout() -> Self disables workflow timeout
   - no_timeouts() -> Self disables both
   - Impl Clone, Debug

5. Unit tests (minimum 8):
   - test_timeout_error_display
   - test_task_timeout_creation
   - test_task_timeout_convenience_constructors
   - test_workflow_timeout_creation
   - test_timeout_config_defaults
   - test_timeout_config_disable_task_timeout
   - test_timeout_config_disable_workflow_timeout
   - test_timeout_config_no_timeouts
  </action>
  <verify>cargo test -p forge_agent workflow::timeout::tests</verify>
  <done>
TimeoutError, TaskTimeout, WorkflowTimeout, TimeoutConfig types exist with:
- Duration-based timeout configuration
- Convenience constructors for common values
- Configurable defaults (30s task, 5m workflow)
- Option-based disable capability
- All unit tests passing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add task_timeout field to TaskContext</name>
  <files>forge_agent/src/workflow/task.rs</files>
  <action>
Modify forge_agent/src/workflow/task.rs:

1. Add task_timeout: Option<Duration> field to TaskContext struct
   - Use Duration from std::time::Duration
   - Default to None for backward compatibility

2. Add with_task_timeout(mut self, timeout: Duration) -> Self builder method

3. Add pub fn task_timeout(&self) -> Option<Duration> accessor

4. Update TaskError enum to include Timeout variant if not present:
   - Timeout(String) - Task exceeded time limit with error message

5. Add unit tests (minimum 3):
   - test_context_without_task_timeout
   - test_context_with_task_timeout
   - test_context_task_timeout_accessor

No changes needed to CompensationAction or CompensationType.
  </action>
  <verify>cargo test -p forge_agent workflow::task::tests::test_context</verify>
  <done>
TaskContext has task_timeout field with:
- Optional Duration for backward compatibility
- Builder pattern for setting timeout
- Accessor method for timeout retrieval
- All existing tests updated and passing
  </done>
</task>

<task type="auto">
  <name>Task 3: Add WorkflowTaskTimedOut event to AuditEvent</name>
  <files>forge_agent/src/audit.rs</files>
  <action>
Modify forge_agent/src/audit.rs:

1. Add WorkflowTaskTimedOut variant to AuditEvent enum:
   ```rust
   WorkflowTaskTimedOut {
       timestamp: DateTime<Utc>,
       workflow_id: String,
       task_id: String,
       task_name: String,
       timeout_secs: u64,
   }
   ```

2. Update AuditEvent::is_workflow_related() if method exists to include new variant

3. Add unit test:
   - test_workflow_task_timed_out_event_serialization

4. Ensure serde derives handle new variant correctly
  </action>
  <verify>cargo test -p forge_agent audit::tests</verify>
  <done>
WorkflowTaskTimedOut event exists with:
- Timestamp, workflow_id, task_id, task_name, timeout_secs fields
- Proper serde serialization
- Audit test coverage
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate timeout config into WorkflowExecutor</name>
  <files>forge_agent/src/workflow/executor.rs</files>
  <action>
Modify forge_agent/src/workflow/executor.rs:

1. Add timeout_config: Option<TimeoutConfig> field to WorkflowExecutor
   - Default to None for backward compatibility

2. Add with_timeout_config(mut self, config: TimeoutConfig) -> Self builder method

3. Add pub fn timeout_config(&self) -> Option<&TimeoutConfig> accessor

4. Add execute_with_timeout() async method:
   - Wraps execute() with tokio::time::timeout if workflow_timeout set
   - Returns WorkflowTimeoutError if workflow exceeds time limit
   - Records WorkflowTaskTimedOut event to audit log

5. Modify execute_task() to handle task timeout:
   - Wrap task execution in tokio::time::timeout if task_timeout set in config
   - Pass task_timeout to TaskContext via builder
   - Return TimeoutError if task exceeds time limit
   - Record WorkflowTaskTimedOut event on timeout

6. Add TimeoutError variant to WorkflowError:
   - Timeout(TimeoutError) wraps timeout module error

7. Add unit tests (minimum 5):
   - test_executor_without_timeout_config
   - test_executor_with_task_timeout
   - test_executor_with_workflow_timeout
   - test_task_timeout_records_audit_event
   - test_workflow_timeout_records_audit_event

8. Modify existing execute() tests to verify no timeout behavior when config is None
  </action>
  <verify>cargo test -p forge_agent workflow::executor::tests</verify>
  <done>
WorkflowExecutor has timeout integration with:
- Optional TimeoutConfig field
- Builder pattern for setting config
- execute_with_timeout() method for workflow-level timeout
- Task timeout handling in execute_task()
- TimeoutError in WorkflowError enum
- Audit event recording for timeouts
- All tests passing
  </done>
</task>

<task type="auto">
  <name>Task 5: Export timeout module and add integration tests</name>
  <files>forge_agent/src/workflow/mod.rs</files>
  <action>
Modify forge_agent/src/workflow/mod.rs:

1. Add pub mod timeout;
2. Add public re-exports: pub use timeout::{TaskTimeout, WorkflowTimeout, TimeoutConfig, TimeoutError};

3. Add integration test in timeout.rs (test module):
   - test_workflow_with_task_timeout
   - Creates workflow with 3 tasks
   - Sets task timeout to 100ms
   - Creates slow task that sleeps for 200ms
   - Verifies task times out and workflow continues/aborts appropriately

   - test_workflow_with_workflow_timeout
   - Creates workflow with 5 tasks
   - Sets workflow timeout to 200ms
   - Creates slow tasks that exceed timeout
   - Verifies workflow times out

   - test_timeout_config_defaults
   - Verifies default values are 30s task, 5m workflow

4. No new dependencies needed (tokio::time already available)
  </action>
  <verify>cargo test -p forge_agent workflow::timeout::tests</verify>
  <done>
Timeout module exported with:
- Public re-exports in workflow module
- Integration tests demonstrating task and workflow timeouts
- Default timeout values verified
- All tests passing
  </done>
</task>

</tasks>

## Verification

1. All unit tests pass (25+ tests)
2. Integration tests demonstrate task timeout behavior
3. Integration tests demonstrate workflow timeout behavior
4. Audit log records timeout events correctly
5. Backward compatibility maintained (timeouts are optional)

## Success Criteria

1. Individual tasks have configurable timeout limits via TaskContext
2. Entire workflow has configurable timeout limit via execute_with_timeout()
3. tokio::time::timeout used for workflow-level timeout
4. tokio::time::sleep (via timeout wrapper) used for per-task timeout
5. TimeoutError variants in TaskResult and WorkflowError
6. Timeout events recorded to audit log

## Output

After completion, create `.planning/phases/10-cancellation-timeouts/10-02-SUMMARY.md`
