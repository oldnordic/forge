---
phase: 09-state-management
plan: 04
type: execute
wave: 4
depends_on: [01, 02]
files_modified:
  - forge_agent/src/workflow/checkpoint.rs
  - forge_agent/src/workflow/executor.rs
  - forge_agent/src/workflow/state.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Validation checkpoints check confidence scores between steps"
    - "Configurable confidence thresholds (default: 70% min, 85% warning)"
    - "ValidationStatus: Passed, Warning, Failed"
    - "Validation failures trigger rollback if configured"
    - "Validation results attached to checkpoint metadata"
  artifacts:
    - path: "forge_agent/src/workflow/checkpoint.rs"
      provides: "ValidationResult, ValidationCheckpoint, ValidationStatus"
      exports: ["ValidationResult", "ValidationCheckpoint", "ValidationStatus"]
    - path: "forge_agent/src/workflow/executor.rs"
      provides: "validate_checkpoint() method, execute_with_validations()"
      covered_by: "Task 3"
  key_links:
    - from: "executor.rs::execute_with_validations"
      to: "checkpoint.rs::ValidationCheckpoint"
      via: "Validate after each task with configurable thresholds"
      pattern: "validate_checkpoint.*threshold"
    - from: "checkpoint.rs::ValidationResult"
      to: "executor.rs::WorkflowCheckpoint"
      via: "Attach validation results to checkpoint metadata"
      pattern: "validation_results.*WorkflowCheckpoint"
    - from: "executor.rs"
      to: "rollback.rs"
      via: "Trigger rollback on validation failure if configured"
      pattern: "rollback_on_failure.*validation"

---

# Plan 09-04: Validation Checkpoints with Confidence Scoring

**Objective**: Implement validation checkpoints between workflow steps that check confidence scores and trigger rollback if needed.

**Purpose**: Prevent error cascading in multi-step workflows by validating intermediate results. Early detection of low-confidence outputs prevents wasted computation on dependent tasks.

**Output**: ValidationCheckpoint type, ValidationResult, validate_checkpoint() method, executor integration

## Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/phases/09-state-management/09-RESEARCH.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/09-state-management/09-01-SUMMARY.md
@.planning/phases/09-state-management/09-02-SUMMARY.md
@forge_agent/src/workflow/executor.rs
@forge_agent/src/workflow/checkpoint.rs
@forge_agent/src/workflow/task.rs

## Requirements

| ID | Requirement | Status |
|----|-------------|--------|
| WOBS-04 | Validation checkpoints between steps check confidence scores and trigger rollback if needed | **Implements** |

## Integration Points

- **09-01 WorkflowCheckpoint**: Attach validation results to checkpoint
- **TaskResult**: Extract confidence from task results
- **WorkflowExecutor**: Run validation after each task, trigger rollback if configured

## Tasks

### Task 1: Implement validation types and configuration

<files>
forge_agent/src/workflow/checkpoint.rs
</files>

<action>
Add validation types to checkpoint module:

1. Create ValidationStatus enum:
   ```rust
   #[derive(Clone, Debug, Serialize, Deserialize)]
   pub enum ValidationStatus {
       Passed,      // Above warning threshold, proceed
       Warning,     // Above minimum but below warning, proceed with log
       Failed,      // Below minimum, rollback if configured
   }
   ```

2. Create RollbackRecommendation enum:
   ```rust
   #[derive(Clone, Debug, Serialize, Deserialize)]
   pub enum RollbackRecommendation {
       ToPreviousCheckpoint,
       SpecificTask(TaskId),
       FullRollback,
       None,  // Continue despite failure
   }
   ```

3. Create ValidationResult struct:
   ```rust
   #[derive(Clone, Debug, Serialize, Deserialize)]
   pub struct ValidationResult {
       pub confidence: f64,  // 0.0 to 1.0
       pub status: ValidationStatus,
       pub message: String,
       pub rollback_recommendation: Option<RollbackRecommendation>,
       pub timestamp: DateTime<Utc>,
   }
   ```

4. Create ValidationCheckpoint config:
   ```rust
   #[derive(Clone, Debug)]
   pub struct ValidationCheckpoint {
       pub min_confidence: f64,      // Default: 0.7
       pub warning_threshold: f64,   // Default: 0.85
       pub rollback_on_failure: bool, // Default: true
   }

   impl Default for ValidationCheckpoint {
       fn default() -> Self {
           Self {
               min_confidence: 0.7,
               warning_threshold: 0.85,
               rollback_on_failure: true,
           }
       }
   }
   ```

Reference SHIELDA validation checkpoint pattern from research.
</action>

<verify>
cargo test -p forge_agent test_validation_types 2>&1 | head -20
cargo test -p forge_agent test_validation_checkpoint_default 2>&1 | head -20
</verify>

<done>
Validation types defined, thresholds configurable, rollback recommendation included
</done>

### Task 2: Implement confidence extraction and validation logic

<files>
forge_agent/src/workflow/checkpoint.rs
</files>

<action>
Add confidence extraction and validation to checkpoint module:

1. Add extract_confidence() function:
   ```rust
   pub fn extract_confidence(result: &TaskResult) -> f64 {
       match result {
           TaskResult::Success => 1.0,
           TaskResult::Skipped => 0.5,
           TaskResult::Failed(_) => 0.0,
           TaskResult::WithCompensation { result, .. } => {
               extract_confidence(result)
           }
       }
   }
   ```

2. Add validate_checkpoint() function:
   ```rust
   pub fn validate_checkpoint(
       task_result: &TaskResult,
       config: &ValidationCheckpoint,
   ) -> ValidationResult
   ```

3. Validation logic:
   - Extract confidence from task result
   - Determine status:
     - confidence >= warning_threshold -> Passed
     - confidence >= min_confidence -> Warning
     - confidence < min_confidence -> Failed
   - Set rollback_recommendation based on status and config.rollback_on_failure
   - Generate descriptive message with percentage

4. Add can_proceed() helper:
   ```rust
   pub fn can_proceed(validation: &ValidationResult) -> bool {
       !matches!(validation.status, ValidationStatus::Failed)
   }
   ```

5. Add requires_rollback() helper:
   ```rust
   pub fn requires_rollback(validation: &ValidationResult) -> bool {
       matches!(
           validation.status,
           ValidationStatus::Failed
       ) && validation.rollback_recommendation.is_some()
   }
   ```

This provides reusable validation logic for any task result.
</action>

<verify>
cargo test -p forge_agent test_extract_confidence 2>&1 | head -30
cargo test -p forge_agent test_validate_checkpoint 2>&1 | head -30
cargo test -p forge_agent test_validation_thresholds 2>&1 | head -20
</verify>

<done>
Confidence extraction handles all TaskResult variants, validation thresholds work correctly, helpers for proceed/rollback decisions
</done>

### Task 3: Integrate validation checkpoints into WorkflowExecutor

<files>
forge_agent/src/workflow/executor.rs
</files>

<action>
Add validation checkpoint integration to WorkflowExecutor:

1. Add validation_config field to WorkflowExecutor:
   ```rust
   pub(in crate::workflow) validation_config: Option<ValidationCheckpoint>,
   ```

2. Add with_validation_config() builder method:
   ```rust
   pub fn with_validation_config(mut self, config: ValidationCheckpoint) -> Self
   ```

3. Add validate_task_result() method:
   ```rust
   fn validate_task_result(
       &self,
       task_result: &TaskResult,
   ) -> Result<ValidationResult, WorkflowError>
   ```

4. Modify execute() to use validation:
   - After each task, if validation_config is set:
     - Call validate_task_result()
     - Attach ValidationResult to checkpoint metadata
     - Log validation result to audit log
     - If requires_rollback() and config says to rollback:
       - Trigger rollback via RollbackEngine
       - Return WorkflowResult with validation failure

5. Add execute_with_validations() public method:
   - Convenience method that sets default validation config
   - Calls execute() with validation enabled
   - Returns validation results in WorkflowResult

6. Attach validation to checkpoint:
   - Modify WorkflowCheckpoint to include Option<ValidationResult>
   - Update checkpoint creation to include validation if available

7. Handle validation failures gracefully:
   - Log warning for Warning status (continue)
   - Trigger rollback for Failed status (if configured)
   - Include validation message in error output

Reference existing checkpoint attachment pattern from 09-01.
</action>

<verify>
cargo test -p forge_agent test_execute_with_validations 2>&1 | head -30
cargo test -p forge_agent test_validation_failure_rollback 2>&1 | head -30
cargo test -p forge_agent test_validation_warning_continue 2>&1 | head -20
</verify>

<done>
WorkflowExecutor validates after each task, warnings logged but continue, failures trigger rollback, results attached to checkpoints
</done>

## Verification

1. Unit tests for confidence extraction from all TaskResult types
2. Unit tests for validation thresholds (Passed/Warning/Failed)
3. Integration tests for execute_with_validations()
4. Tests verify rollback triggered on validation failure
5. Tests verify warnings don't stop execution
6. Tests verify validation results in checkpoint metadata

## Success Criteria

- [ ] ValidationCheckpoint has configurable thresholds (default 70%/85%)
- [ ] validate_checkpoint() returns correct status based on confidence
- [ ] WorkflowExecutor validates after each task when config is set
- [ ] Validation failures trigger rollback when configured
- [ ] Validation warnings are logged but don't stop workflow
- [ ] Validation results attached to checkpoint metadata
- [ ] All tests pass, cargo check passes

## Output

After completion, create `.planning/phases/09-state-management/09-04-SUMMARY.md`
