---
phase: 09-state-management
plan: 03
type: execute
wave: 3
depends_on: [01]
files_modified:
  - forge_agent/src/workflow/rollback.rs
  - forge_agent/src/workflow/executor.rs
  - forge_agent/src/workflow/task.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "External tool side effects use compensation transactions for rollback"
    - "CompensationRegistry tracks undo actions for each task"
    - "ToolCompensation wraps undo function for external tools"
    - "Compensation actions registered before task execution"
    - "RollbackEngine executes compensations in reverse order"
  artifacts:
    - path: "forge_agent/src/workflow/rollback.rs"
      provides: "CompensationRegistry, ToolCompensation"
      exports: ["CompensationRegistry", "ToolCompensation"]
    - path: "forge_agent/src/workflow/executor.rs"
      provides: "Compensation registration integration"
      covered_by: "Task 2"
    - path: "forge_agent/src/workflow/task.rs"
      provides: "WorkflowTask::compensation() trait method"
      covered_by: "Task 3"
  key_links:
    - from: "executor.rs"
      to: "rollback.rs::CompensationRegistry"
      via: "Register compensations before task execution"
      pattern: "register_compensation"
    - from: "rollback.rs::RollbackEngine"
      to: "rollback.rs::CompensationRegistry"
      via: "Look up compensations during rollback"
      pattern: "compensation_registry.*get"
    - from: "task.rs::WorkflowTask"
      to: "rollback.rs::ExecutableCompensation"
      via: "Task trait provides compensation action"
      pattern: "compensation.*into"

---

# Plan 09-03: Compensation Transaction Registry for External Tool Rollback

**Objective**: Implement compensation transaction registry for external tool side effects using Saga pattern.

**Purpose**: Enable workflows to roll back external tool actions (file edits, process spawns) by registering compensation actions that undo side effects when tasks fail.

**Output**: CompensationRegistry, ToolCompensation type, executor integration, compensation execution

## Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/phases/09-state-management/09-RESEARCH.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/09-state-management/09-01-SUMMARY.md
@forge_agent/src/workflow/rollback.rs
@forge_agent/src/workflow/task.rs
@forge_agent/src/workflow/executor.rs

## Requirements

| ID | Requirement | Status |
|----|-------------|--------|
| WSTA-05 | External tool side effects use compensation transactions for rollback (Saga pattern) | **Implements** |

## Integration Points

- **Existing RollbackEngine**: Extend to use CompensationRegistry
- **Existing ExecutableCompensation**: Reuse from rollback module
- **WorkflowTask trait**: Add compensation() method hook
- **WorkflowExecutor**: Register compensations before task execution

## Tasks

### Task 1: Implement CompensationRegistry for tracking undo actions

<files>
forge_agent/src/workflow/rollback.rs
</files>

<action>
Add CompensationRegistry to rollback module:

1. Create ToolCompensation struct:
   ```rust
   #[derive(Clone)]
   pub struct ToolCompensation {
       pub description: String,
       compensate: Arc<dyn Fn(&TaskContext) -> Result<TaskResult, TaskError> + Send + Sync>,
   }
   ```

2. Implement ToolCompensation methods:
   - new(description, compensate_fn) - Create with undo function
   - execute(context) - Execute the compensation
   - file_compensation(path) - Helper for file creation rollback (delete file)
   - process_compensation(pid) - Helper for process rollback (kill process)

3. Create CompensationRegistry struct:
   ```rust
   pub struct CompensationRegistry {
       compensations: HashMap<TaskId, ToolCompensation>,
   }
   ```

4. Implement CompensationRegistry methods:
   - register(task_id, compensation) - Register compensation for task
   - get(task_id) -> Option<&ToolCompensation> - Get compensation by task ID
   - has_compensation(task_id) -> bool - Check if task has compensation
   - remove(task_id) - Remove compensation after successful rollback
   - validate_coverage() -> CompensationReport - Check coverage percentage

5. Add helper methods for common compensations:
   - register_file_creation(task_id, file_path) - Auto-register delete compensation
   - register_process_spawn(task_id, pid) - Auto-register kill compensation

Reference existing ExecutableCompensation pattern for undo function wrapping.
</action>

<verify>
cargo test -p forge_agent test_compensation_registry 2>&1 | head -30
cargo test -p forge_agent test_tool_compensation 2>&1 | head -20
</verify>

<done>
CompensationRegistry tracks task compensations, ToolCompensation wraps undo functions, helper methods for common patterns
</done>

### Task 2: Add compensation registration to WorkflowExecutor

<files>
forge_agent/src/workflow/executor.rs
</files>

<action>
Integrate compensation registration into WorkflowExecutor:

1. Add field to WorkflowExecutor:
   ```rust
   pub(in crate::workflow) compensation_registry: CompensationRegistry,
   ```

2. Modify execute_task() to register compensations:
   - Before executing task, check if task has compensation method
   - Call task.compensation() to get compensation action
   - Convert to ToolCompensation and register in registry
   - Store registry reference for potential rollback

3. Add register_compensation() method:
   ```rust
   pub fn register_compensation(&mut self, task_id: TaskId, compensation: ToolCompensation)
   ```
   - Allow manual compensation registration
   - Override existing compensation if already registered

4. Add register_file_compensation() helper:
   - Convenience method for file creation tasks
   - Auto-generates delete compensation

5. Add validate_compensation_coverage() method:
   - Calls registry.validate_coverage()
   - Logs warning if coverage < 100%
   - Returns CompensationReport for inspection

6. Update RollbackEngine.execute_rollback() to use registry:
   - Look up compensations from registry
   - Execute ToolCompensation via execute() method
   - Remove compensation after successful execution

Reference existing rollback_engine field for similar integration pattern.
</action>

<verify>
cargo test -p forge_agent test_executor_compensation_registration 2>&1 | head -30
cargo test -p forge_agent test_compensation_coverage_validation 2>&1 | head -20
</verify>

<done>
WorkflowExecutor registers compensations before tasks, helper methods for common patterns, validation logs warnings
</done>

### Task 3: Update WorkflowTask trait to support compensation method

<files>
forge_agent/src/workflow/task.rs
</files>

<action>
Update WorkflowTask trait for compensation integration:

1. Add compensation() method to WorkflowTask trait (already exists, verify):
   ```rust
   fn compensation(&self) -> Option<CompensationAction> {
       None
   }
   ```

2. Note: Current trait already has compensation() method
   - Verify it returns Option<CompensationAction>
   - Ensure CompensationAction can convert to ToolCompensation

3. Add From<CompensationAction> for ToolCompensation in rollback.rs:
   ```rust
   impl From<CompensationAction> for ToolCompensation {
       fn from(action: CompensationAction) -> Self {
           match action.action_type {
               CompensationType::Skip => ToolCompensation::skip(action.description),
               CompensationType::Retry => ToolCompensation::retry(action.description),
               CompensationType::UndoFunction => {
                   // Note: Can't create undo from serializable action
                   // This is a no-op compensation
                   ToolCompensation::skip(action.description)
               }
           }
       }
   }
   ```

4. Document compensation registration pattern:
   - Tasks implement compensation() to return description
   - Executor wraps with executable function
   - Manual registration for full undo functions

The trait already exists - this task ensures proper integration.
</action>

<verify>
cargo test -p forge_agent test_task_compensation_integration 2>&1 | head -30
cargo doc -p forge_agent --no-deps --open 2>&1 | grep -i compensation
</verify>

<done>
WorkflowTask::compensation() method integrates with registry, From conversion implemented, documentation complete
</done>

## Verification

1. Unit tests for CompensationRegistry CRUD operations
2. Unit tests for ToolCompensation file/process helpers
3. Integration tests for executor registration
4. Rollback tests verify compensations execute
5. Coverage validation tests

## Success Criteria

- [ ] CompensationRegistry tracks task compensations
- [ ] ToolCompensation wraps undo functions for external tools
- [ ] WorkflowExecutor registers compensations before tasks
- [ ] RollbackEngine executes compensations in reverse order
- [ ] File and process helper methods work correctly
- [ ] Coverage validation detects missing compensations
- [ ] All tests pass, cargo check passes

## Output

After completion, create `.planning/phases/09-state-management/09-03-SUMMARY.md`
